{"version":3,"file":"index.cjs","sources":["../src/index.tsx"],"sourcesContent":["import * as React from \"react\";\nimport { createPortal } from \"react-dom\";\n\nimport \"./styles.scss\";\n\nexport type EmbedEvent =\n  | { type: \"DOCUMENT_LOADED\"; data: { document_id: string } }\n  | { type: \"SUBMISSION_SENT\"; data: { submission_id: string } };\n\ntype Props = InlineProps | ModalProps;\n\ninterface CommonProps {\n  companyIdentifier?: string;\n  context?: Record<string, unknown>;\n  onEmbedEvent?: (event: EmbedEvent) => Promise<void> | void;\n  locale?: \"en\" | \"de\" | \"es\" | \"fr\" | \"it\" | \"pt\";\n}\n\ninterface InlineProps extends CommonProps {\n  mode: \"inline\";\n  className?: string;\n  style?: React.CSSProperties;\n  documentURL?: string;\n}\n\ninterface ModalProps extends CommonProps {\n  mode?: \"modal\";\n  children: React.ReactElement;\n}\n\ninterface InternalProps {\n  editorURL: string;\n}\n\nconst CloseIcon: React.FC = () => (\n  <svg\n    height=\"512\"\n    viewBox=\"0 0 512 512\"\n    width=\"512\"\n    xmlSpace=\"preserve\"\n    xmlns=\"http://www.w3.org/2000/svg\"\n  >\n    <path d=\"M443.6 387.1 312.4 255.4l131.5-130c5.4-5.4 5.4-14.2 0-19.6l-37.4-37.6c-2.6-2.6-6.1-4-9.8-4-3.7 0-7.2 1.5-9.8 4L256 197.8 124.9 68.3c-2.6-2.6-6.1-4-9.8-4-3.7 0-7.2 1.5-9.8 4L68 105.9c-5.4 5.4-5.4 14.2 0 19.6l131.5 130L68.4 387.1c-2.6 2.6-4.1 6.1-4.1 9.8 0 3.7 1.4 7.2 4.1 9.8l37.4 37.6c2.7 2.7 6.2 4.1 9.8 4.1 3.5 0 7.1-1.3 9.8-4.1L256 313.1l130.7 131.1c2.7 2.7 6.2 4.1 9.8 4.1 3.5 0 7.1-1.3 9.8-4.1l37.4-37.6c2.6-2.6 4.1-6.1 4.1-9.8-.1-3.6-1.6-7.1-4.2-9.7z\" />\n  </svg>\n);\n\nconst loadDocument = async ({\n  iframeRef,\n  documentDataURL,\n  editorDomain,\n}: {\n  iframeRef: React.RefObject<HTMLIFrameElement>;\n  documentDataURL: string;\n  editorDomain: string;\n}) => {\n  const editorDomainURL = new URL(editorDomain);\n  iframeRef.current?.contentWindow?.postMessage(\n    JSON.stringify({\n      type: \"LOAD_DOCUMENT\",\n      data: { data_url: documentDataURL },\n    }),\n    editorDomainURL.origin\n  );\n};\n\nconst DEFAULT_LOCALE = \"en\";\n\nconst isInlineComponent = (props: Props): props is InlineProps =>\n  (props as InlineProps).mode === \"inline\";\n\nconst InlineComponent = React.forwardRef<\n  HTMLIFrameElement,\n  Pick<InlineProps, \"className\" | \"style\">\n>(({ className, style }, iframeRef) => {\n  return (\n    <iframe\n      ref={iframeRef}\n      className={className}\n      style={{ border: 0, ...style }}\n    />\n  );\n});\n\nconst ModalComponent = React.forwardRef<\n  HTMLIFrameElement,\n  InternalProps & Pick<ModalProps, \"children\">\n>(({ children, editorURL }, iframeRef) => {\n  const [shouldDisplayModal, setShouldDisplayModal] = React.useState(false);\n\n  const handleAnchorClick = React.useCallback((e: Event) => {\n    e.preventDefault();\n    setShouldDisplayModal(true);\n  }, []);\n\n  const handleCloseModal = React.useCallback(() => {\n    setShouldDisplayModal(false);\n  }, []);\n\n  return (\n    <>\n      {shouldDisplayModal &&\n        createPortal(\n          <div className=\"simplePDF_container\" aria-modal=\"true\">\n            <div className=\"simplePDF_content\">\n              <button\n                onClick={handleCloseModal}\n                className=\"simplePDF_close\"\n                aria-label=\"Close PDF editor modal\"\n              >\n                <CloseIcon />\n              </button>\n              <div className=\"simplePDF_iframeContainer\">\n                <iframe\n                  ref={iframeRef}\n                  referrerPolicy=\"no-referrer-when-downgrade\"\n                  className=\"simplePDF_iframe\"\n                  src={editorURL}\n                />\n              </div>\n            </div>\n          </div>,\n          document.body\n        )}\n\n      {React.cloneElement(children, { onClick: handleAnchorClick })}\n    </>\n  );\n});\n\nexport const EmbedPDF: React.FC<Props> = (props) => {\n  const { context, companyIdentifier, locale } = props;\n  const [documentState, setDocumentState] = React.useState<{\n    type: \"iframe_event\" | \"cors_proxy_fallback\" | null;\n    value: string | null;\n    isEditorReady: boolean;\n  }>({ type: null, value: null, isEditorReady: false });\n  const iframeRef = React.useRef<HTMLIFrameElement>(null);\n\n  const url: string | null = isInlineComponent(props)\n    ? props.documentURL ?? null\n    : props.children?.props?.href ?? null;\n\n  React.useEffect(() => {\n    if (!url) {\n      return;\n    }\n\n    const fetchedDocumentBlob = async () => {\n      const response = await fetch(url, {\n        method: \"GET\",\n        credentials: \"same-origin\",\n      });\n\n      if (!response.ok) {\n        throw new Error(\n          `Failed to retrieve the document: ${JSON.stringify({\n            status: response.status,\n            url,\n          })}`\n        );\n      }\n\n      const blob = await response.blob();\n\n      const reader = new FileReader();\n      await new Promise((resolve, reject) => {\n        reader.onload = resolve;\n        reader.onerror = reject;\n        reader.readAsDataURL(blob);\n      });\n\n      return reader.result as string;\n    };\n\n    fetchedDocumentBlob()\n      .then((dataURL) =>\n        setDocumentState((prev) => ({\n          ...prev,\n          type: \"iframe_event\",\n          value: dataURL,\n        }))\n      )\n      .catch(() => {\n        setDocumentState((prev) => ({\n          ...prev,\n          type: \"cors_proxy_fallback\",\n          value: url,\n        }));\n      });\n  }, [url]);\n\n  const editorDomain = React.useMemo(\n    () => `https://${companyIdentifier ?? \"embed\"}.simplepdf.eu`,\n    [companyIdentifier]\n  );\n\n  React.useEffect(() => {\n    if (\n      !documentState.isEditorReady ||\n      documentState.type !== \"iframe_event\" ||\n      documentState.value === null\n    ) {\n      return;\n    }\n\n    loadDocument({\n      iframeRef,\n      documentDataURL: documentState.value,\n      editorDomain,\n    });\n  }, [documentState, editorDomain]);\n\n  const embedEventHandler = React.useCallback(\n    async (event: MessageEvent<string>) => {\n      const eventOrigin = new URL(event.origin).origin;\n      const iframeOrigin = new URL(editorDomain).origin;\n\n      if (eventOrigin !== iframeOrigin) {\n        return;\n      }\n\n      const isTrustedIframe = event.source === iframeRef.current?.contentWindow;\n\n      if (!isTrustedIframe) {\n        return;\n      }\n\n      const payload: (EmbedEvent | { type: \"EDITOR_READY\" }) | null = (() => {\n        try {\n          return JSON.parse(event.data);\n        } catch (e) {\n          console.error(\"Failed to parse iFrame event payload\");\n          return null;\n        }\n      })();\n\n      switch (payload?.type) {\n        case \"EDITOR_READY\":\n          setDocumentState((prev) => ({ ...prev, isEditorReady: true }));\n          return;\n        case \"DOCUMENT_LOADED\":\n        case \"SUBMISSION_SENT\":\n          try {\n            await props.onEmbedEvent?.(payload);\n          } catch (e) {\n            console.error(\n              `onEmbedEvent failed to execute: ${JSON.stringify(e)}`\n            );\n          }\n\n          return;\n\n        default:\n          return;\n      }\n    },\n    [props.onEmbedEvent, editorDomain]\n  );\n\n  React.useEffect(() => {\n    window.addEventListener(\"message\", embedEventHandler, false);\n\n    return () => window.removeEventListener(\"message\", embedEventHandler);\n  }, [embedEventHandler]);\n\n  const encodedContext: string | null = React.useMemo(() => {\n    if (!context) {\n      return null;\n    }\n\n    try {\n      return encodeURIComponent(btoa(JSON.stringify(context)));\n    } catch (e) {\n      console.error(`Failed to encode the context: ${JSON.stringify(e)}`, {\n        context,\n      });\n      return null;\n    }\n  }, [JSON.stringify(context)]);\n\n  const editorURL = React.useMemo(() => {\n    const simplePDFEditorURL = new URL(\n      `/${locale ?? DEFAULT_LOCALE}/editor`,\n      editorDomain\n    );\n\n    if (encodedContext) {\n      simplePDFEditorURL.searchParams.set(\"context\", encodedContext);\n    }\n\n    if (url) {\n      simplePDFEditorURL.searchParams.set(\"loadingPlaceholder\", \"true\");\n    }\n\n    if (\n      documentState?.type === \"cors_proxy_fallback\" &&\n      documentState?.value !== null\n    ) {\n      simplePDFEditorURL.searchParams.set(\"open\", documentState.value);\n    }\n\n    return simplePDFEditorURL.href;\n  }, [editorDomain, url, encodedContext, documentState, locale]);\n\n  const isInline = isInlineComponent(props);\n\n  React.useEffect(() => {\n    // SSR support for the inline component:\n    // Set the iframe URL only once it's rendered client side so that we can listen to the \"READY\" event\n    // (The modal component is already only rendered client side as it requires a user click to load the iframe)\n    if (!isInline) {\n      return;\n    }\n\n    if (iframeRef && iframeRef.current) {\n      iframeRef.current.src = editorURL;\n    }\n  }, [editorURL, isInline]);\n\n  if (isInline) {\n    return (\n      <InlineComponent\n        className={props.className}\n        style={props.style}\n        ref={iframeRef}\n      />\n    );\n  }\n\n  return (\n    <ModalComponent\n      children={props.children}\n      editorURL={editorURL}\n      ref={iframeRef}\n    />\n  );\n};\n"],"names":["CloseIcon","React","height","viewBox","width","xmlSpace","xmlns","createElement","d","isInlineComponent","props","mode","InlineComponent","forwardRef","_a","iframeRef","className","style","ref","__assign","border","ModalComponent","children","editorURL","_b","useState","shouldDisplayModal","setShouldDisplayModal","handleAnchorClick","useCallback","e","preventDefault","handleCloseModal","Fragment","createPortal","onClick","referrerPolicy","src","document","body","cloneElement","context","companyIdentifier","locale","_e","type","value","isEditorReady","documentState","setDocumentState","useRef","url","documentURL","_d","_c","href","useEffect","__awaiter","fetch","method","credentials","response","sent","ok","Error","JSON","stringify","status","blob","reader","FileReader","Promise","resolve","reject","onload","onerror","readAsDataURL","result","then","dataURL","prev","catch","editorDomain","useMemo","concat","documentDataURL","editorDomainURL","URL","current","contentWindow","postMessage","data","data_url","origin","loadDocument","embedEventHandler","event","eventOrigin","iframeOrigin","source","payload","parse","console","error","onEmbedEvent","call","e_1","window","addEventListener","removeEventListener","encodedContext","encodeURIComponent","btoa","simplePDFEditorURL","searchParams","set","isInline"],"mappings":"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"}